(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-index-history"],{"63e3":function(e,t,n){"use strict";n.r(t);var s=n("cde1"),i=n.n(s);for(var a in s)"default"!==a&&function(e){n.d(t,e,(function(){return s[e]}))}(a);t["default"]=i.a},a3a9:function(e,t,n){"use strict";n.r(t);var s=n("d04f"),i=n("63e3");for(var a in i)"default"!==a&&function(e){n.d(t,e,(function(){return i[e]}))}(a);var o,r=n("f0c5"),c=Object(r["a"])(i["default"],s["b"],s["c"],!1,null,"48aa1b5a",null,!1,s["a"],o);t["default"]=c.exports},cde1:function(e,t,n){"use strict";var s=n("4ea4");n("99af"),Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=s(n("7621")),a=s(n("3c2d")),o={data:function(){return{title:"Hello",baseUrl:getApp().globalData.baseUrl,wsBaseUrl:getApp().globalData.wsBaseUrl,visitors:[],token:"",timer:null,wsOpen:!1,noticeContent:"通知: 无",page:1,avatarList:[{url:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-dc-site/460d46d0-4fcc-11eb-8ff1-d5dcf8779628.png"},{url:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-dc-site/460d46d0-4fcc-11eb-8ff1-d5dcf8779628.png"},{url:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-dc-site/460d46d0-4fcc-11eb-8ff1-d5dcf8779628.png"}]}},onShow:function(){var e=uni.getStorageSync("app");console.log(e),e&&(this.token=e.token),this.checkAuth(),this.getNewOnlineUser(1)},onLoad:function(){},onPullDownRefresh:function(){console.log("refresh"),this.getNewOnlineUser(1),setTimeout((function(){uni.stopPullDownRefresh()}),1e3)},onReachBottom:function(){console.log(this.page),this.page++,this.getOnlineUser(this.page)},methods:{onlineIntime:function(){var e=this,t=this,n=null;uni.connectSocket({url:this.wsBaseUrl+"?token="+this.token}),uni.onSocketClose((function(e){clearInterval(n),console.log("WebSocket 连接断开")})),uni.onSocketOpen((function(e){console.log("WebSocket 连接已打开");var t={type:"ping",data:""};n=setInterval((function(){uni.sendSocketMessage({data:JSON.stringify(t)})}),5e3)})),uni.onSocketMessage((function(n){var s=JSON.parse(n.data);switch(s.type){case"userOnline":i.default.playVoice(),t.showNoticeBar(s.data.username+"来了");break;case"userOffline":t.showNoticeBar(s.data.name+"离线");break;case"message":e.recvMessage(s.data);break}}))},recvMessage:function(e){this.visitors=a.default.receiveMessage(this.visitors,e),this.showNoticeBar(e.name+":"+e.content),"yes"!=e.is_kefu&&i.default.playVoice()},getOnlineUser:function(e){var t=this,n=this.baseUrl;uni.request({url:n+"/visitors?page="+e+"&pagesize=14&token="+t.token,method:"GET",success:function(e){if(console.log(e),e.data.result.list){var n=e.data.result.list;0==t.visitors.length?t.visitors=n:t.visitors=t.visitors.concat(t.visitors,n),t.visitors=t.removeRepeat(t.visitors)}},fail:function(e){}})},getNewOnlineUser:function(e){var t=this,n=this.baseUrl;uni.request({url:n+"/visitors?page="+e+"&pagesize=14&token="+t.token,method:"GET",success:function(e){if(e.data.result.list){var n=e.data.result.list;t.visitors=n}}})},chatVisitor:function(e,t){uni.navigateTo({url:"/pages/index/detail?visitor_id="+t})},showNoticeBar:function(e){var t=this;t.noticeContent=e},checkAuth:function(){var e=this;uni.request({url:e.baseUrl+"/uc/v1/refreshToken?token="+e.token,method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},success:function(t){var n=t.data.code;2e4!=n?uni.navigateTo({url:"/pages/index/login"}):(uni.setStorageSync("app",{token:t.data.result.token}),e.onlineIntime())}})},removeRepeat:function(e){for(var t,n=0,s=e.length,i={},a=[];n<s;n++)t=e[n].id,t=typeof t+t,i[t]||(i[t]=1,a.push(e[n]));return a},showLastMessage:function(e){return""==e?"无消息":e},formatTime:function(e,t){e=Math.round(new Date(e).getTime()/1e3);return i.default.beautifyTime(e)}}};t.default=o},d04f:function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return s}));var s={uniNoticeBar:n("b452").default,uniList:n("498f").default,uniListChat:n("cec3").default,uniIcons:n("f281").default},i=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("v-uni-view",{staticClass:"content"},[n("uni-notice-bar",{staticClass:"flyNoticeBar",attrs:{showClose:"false",showIcon:!0,single:"true",text:e.noticeContent}}),n("uni-list",{staticClass:"mt20"},[n("uni-list",{attrs:{border:!0}},e._l(e.visitors,(function(t){return n("uni-list-chat",{attrs:{clickable:!0,title:t.username,avatar:e.baseUrl+t.avator,note:e.showLastMessage(t.last_message),time:e.formatTime(t.updated_at),"badge-positon":"left","badge-text":t.unread_num},on:{click:function(n){arguments[0]=n=e.$handleEvent(n),e.chatVisitor(n,t.visitor_id)}}})})),1)],1),n("v-uni-view",{directives:[{name:"show",rawName:"v-show",value:0==e.visitors.length,expression:"visitors.length==0"}],staticClass:"flyNotice"},[n("uni-icons",{staticClass:"mr-10",attrs:{type:"chatboxes",color:"#808080",size:"30"}}),e._v("暂无在线访客")],1)],1)},a=[]}}]);